# Candidacy Platform Configuration Guide

Complete configuration reference for the Candidacy recruitment platform.

## Overview

Candidacy uses a **two-tier configuration system**:

1. **Environment Variables** (`.env`) - Infrastructure and secrets
2. **Database Settings** (Admin Service) - Application behavior and features

This separation ensures:
- Infrastructure configs are version-controlled and deployment-specific
- Application settings are dynamically configurable without redeployment
- Sensitive data (API keys, secrets) are properly secured
- Settings can be updated via API or Admin UI

---

## Quick Start

### Initial Setup

```bash
# 1. Copy environment template
cp .env.example .env

# 2. Run complete setup (recommended)
make setup

# This will:
# - Generate APP_KEY and JWT_SECRET automatically
# - Build base Docker image
# - Initialize databases from DBML
# - Start all services
# - Seed 50+ configuration settings
```

### Manual Configuration

```bash
# Generate secrets manually
php -r "echo 'APP_KEY=base64:' . base64_encode(random_bytes(32)) . PHP_EOL;"
php -r "echo 'JWT_SECRET=' . base64_encode(random_bytes(64)) . PHP_EOL;"

# Update .env with generated values
# Then start services
make up
```

---

## Environment Variables (.env)

Located at: `/home/steelburn/Development/candidacy/.env`

### Global Settings

```bash
# Environment
APP_ENV=local                    # local, staging, production
APP_DEBUG=true                   # Enable debug mode (false in production)

# Security Keys (auto-generated by setup)
APP_KEY=base64:...              # Laravel encryption key
JWT_SECRET=...                  # JWT authentication secret
```

### Database Configuration

```bash
DB_CONNECTION=mysql
DB_HOST=mysql                   # Docker service name
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=root
```

**Service Databases** (auto-created by `make dbml-init`):
- `candidacy_auth` - Authentication and users
- `candidacy_admin` - System settings and configuration
- `candidacy_candidate` - Candidate profiles and CVs
- `candidacy_vacancy` - Job postings
- `candidacy_ai` - AI processing jobs
- `candidacy_matching` - Match records
- `candidacy_interview` - Interview schedules
- `candidacy_offer` - Job offers
- `candidacy_onboarding` - Onboarding workflows
- `candidacy_document_parser` - Document parsing operations
- `candidacy_notification` - Notification history
- `candidacy_reporting` - Analytics data

### Cache & Queue

```bash
CACHE_DRIVER=redis
QUEUE_CONNECTION=redis
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=null
```

### Logging

```bash
LOG_CHANNEL=stack              # stack, stderr, single
LOG_LEVEL=debug                # debug, info, warning, error
```

### Service URLs (Internal Docker Network)

```bash
ADMIN_SERVICE_URL=http://admin-service:8080
CANDIDATE_SERVICE_URL=http://candidate-service:8080
VACANCY_SERVICE_URL=http://vacancy-service:8080
AI_SERVICE_URL=http://ai-service:8080
```

---

## Database-Managed Settings

All application-level configurations are stored in the database and managed via the **Admin Service**.

### Accessing Settings

#### Via API

```bash
# Get all settings
curl http://localhost:8090/api/settings | jq

# Get settings by category
curl http://localhost:8090/api/settings?category=ai | jq

# Get specific setting
curl http://localhost:8090/api/settings/ai.provider | jq

# Update setting
curl -X PUT http://localhost:8090/api/settings/ai.provider \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{"value": "openrouter"}'
```

#### Via Admin UI

1. Login to main frontend: http://localhost:3501
2. Navigate to **Admin** â†’ **Settings**
3. Browse by category or search
4. Edit values with specialized controls (color pickers, dropdowns, sliders)

### Seeding Configuration

```bash
# Seed all 50+ default settings
make seed-config

# Or manually
docker compose exec admin-service php artisan db:seed --class=ConfigurationSeeder
```

---

## Configuration Categories

### 1. System Configuration

**Category**: `system`

| Key | Default | Description |
|-----|---------|-------------|
| `app.name` | `Candidacy` | Application name in UI |
| `app.company_name` | `Candidacy Inc.` | Company branding |
| `app.contact_email` | `contact@candidacy.com` | Support email |
| `app.candidate_portal_url` | `http://localhost:5173` | Applicant portal URL |
| `app.timezone` | `UTC` | Default timezone |
| `app.language` | `en` | Default language |

**Usage**:
```bash
# Update company name
curl -X PUT http://localhost:8090/api/settings/app.company_name \
  -d '{"value": "ACME Corp"}'
```

---

### 2. AI Configuration

**Category**: `ai`

#### AI Provider Selection

| Key | Default | Options | Description |
|-----|---------|---------|-------------|
| `ai.provider` | `ollama` | `ollama`, `openrouter` | Active AI provider |
| `features.enable_ai` | `true` | boolean | Master AI feature toggle |

#### Ollama Configuration

| Key | Default | Description |
|-----|---------|-------------|
| `ai.ollama.url` | `http://192.168.88.120:11535` | Ollama API endpoint |
| `ai.ollama.model.default` | `mistral` | Default model |
| `ai.ollama.model.matching` | `llama3.2:3b` | Matching model |
| `ai.ollama.model.cv_parsing` | `llama3.2` | CV parsing model |

#### OpenRouter Configuration

| Key | Default | Description |
|-----|---------|-------------|
| `ai.openrouter.api_key` | *(empty)* | API key (sensitive) |
| `ai.openrouter.model` | `mistralai/mistral-7b-instruct` | Model name |
| `ai.openrouter.base_url` | `https://openrouter.ai/api/v1` | API endpoint |

#### Additional AI Providers

| Provider | Keys | Description |
|----------|------|-------------|
| **OpenAI** | `ai.openai.api_key`<br>`ai.openai.model`<br>`ai.openai.base_url` | GPT models |
| **Google Gemini** | `ai.gemini.api_key`<br>`ai.gemini.model`<br>`ai.gemini.base_url` | Gemini models |
| **Azure OpenAI** | `ai.azure.api_key`<br>`ai.azure.endpoint`<br>`ai.azure.deployment` | Azure-hosted models |
| **LiteLLM** | `ai.litellm.base_url`<br>`ai.litellm.api_key` | Multi-provider proxy |
| **llama.cpp** | `ai.llamacpp.base_url` | Local llama.cpp server |

#### AI Generation Parameters

| Key | Default | Range | Description |
|-----|---------|-------|-------------|
| `ai.generation.timeout` | `300` | 30-600 | Timeout in seconds |
| `ai.generation.temperature` | `0.7` | 0.0-1.0 | Creativity (lower = deterministic) |
| `ai.generation.context_length` | `8192` | 2048-32768 | Context window size |

**Example Configuration**:

```bash
# Switch to OpenRouter
curl -X PUT http://localhost:8090/api/settings/ai.provider \
  -d '{"value": "openrouter"}'

# Set API key
curl -X PUT http://localhost:8090/api/settings/ai.openrouter.api_key \
  -d '{"value": "sk-or-v1-..."}'

# Adjust temperature for more deterministic results
curl -X PUT http://localhost:8090/api/settings/ai.generation.temperature \
  -d '{"value": "0.3"}'
```

---

### 3. Document Parser Configuration

**Category**: `document_parser`, `ai`

| Key | Default | Range | Description |
|-----|---------|-------|-------------|
| `document_parser.use_granite_docling` | `true` | boolean | Enable IBM Granite Docling |
| `document_parser.granite_model` | `ibm/granite-docling:258m` | - | Model name |
| `document_parser.timeout` | `60` | 10-300 | Parsing timeout (seconds) |
| `document_parser.image_resolution` | `150` | 72-300 | PDF-to-image DPI |

**Features**:
- **Granite Docling**: 85-95% accuracy for resume parsing
- **Structure Preservation**: Tables, lists, sections maintained
- **Automatic Fallback**: Uses basic parser if Docling unavailable

**Performance Tuning**:

```bash
# Increase timeout for complex documents
curl -X PUT http://localhost:8090/api/settings/document_parser.timeout \
  -d '{"value": "120"}'

# Higher resolution for better accuracy (slower)
curl -X PUT http://localhost:8090/api/settings/document_parser.image_resolution \
  -d '{"value": "300"}'
```

See also: [Document Parser Service Configuration](services/document-parser-service/DOCLING_CONFIG.md)

---

### 4. Matching Configuration

**Category**: `ai`

| Key | Default | Range | Description |
|-----|---------|-------|-------------|
| `matching.min_score_threshold` | `40` | 0-100 | Discard matches below this |
| `matching.max_retry_attempts` | `3` | 1-10 | Retry if AI fails |
| `matching.display_threshold` | `60` | 0-100 | UI filter threshold |
| `recruitment.auto_matching` | `true` | boolean | Auto-match on vacancy creation |
| `features.enable_auto_matching` | `true` | boolean | Master auto-match toggle |

**Matching Quality**:
- Matches below `min_score_threshold` are automatically discarded
- Missing RECOMMENDATION triggers retry (up to `max_retry_attempts`)
- Typo-proof parsing handles AI output inconsistencies

**Example**:

```bash
# Only save high-quality matches
curl -X PUT http://localhost:8090/api/settings/matching.min_score_threshold \
  -d '{"value": "70"}'

# Disable auto-matching
curl -X PUT http://localhost:8090/api/settings/recruitment.auto_matching \
  -d '{"value": "false"}'
```

---

### 5. Recruitment Configuration

**Category**: `recruitment`

| Key | Default | Range | Description |
|-----|---------|-------|-------------|
| `recruitment.offer_expiry_days` | `7` | 1-90 | Days before offers expire |
| `recruitment.interview_reminder_hours` | `24` | 1-168 | Hours before interview reminder |

---

### 6. Storage Configuration

**Category**: `storage`

| Key | Default | Range | Description |
|-----|---------|-------|-------------|
| `storage.cv_storage_limit_mb` | `10` | 1-50 | Max CV file size (MB) |
| `storage.max_upload_size` | `10` | 1-100 | Max upload size (MB) |

**Note**: Also update PHP upload limits in `docker/php/conf.d/uploads.ini`:

```ini
upload_max_filesize = 10M
post_max_size = 10M
```

---

### 7. Feature Flags

**Category**: `features`, `ai`

| Key | Default | Description |
|-----|---------|-------------|
| `features.enable_ai` | `true` | Master AI toggle |
| `features.enable_notifications` | `true` | Email notifications |
| `features.enable_auto_matching` | `true` | Automatic matching |

---

### 8. UI Customization

**Category**: `ui`

| Key | Default | Range | Description |
|-----|---------|-------|-------------|
| `ui.login_background_image` | *(empty)* | URL | Login page background |
| `ui.max_content_width` | `1400` | 0-2560 | Max content width (px) |
| `ui.sidebar_width` | `260` | 200-400 | Sidebar width (px) |
| `ui.primary_color` | `#4F46E5` | hex | Primary brand color |
| `ui.items_per_page` | `20` | 10-100 | Default pagination |
| `ui.date_format` | `YYYY-MM-DD` | - | Date display format |
| `ui.time_format` | `HH:mm` | - | Time format (24h/12h) |
| `ui.enable_dark_mode` | `false` | boolean | Default dark mode |

**Example**:

```bash
# Customize branding
curl -X PUT http://localhost:8090/api/settings/ui.primary_color \
  -d '{"value": "#10B981"}'

# Enable dark mode by default
curl -X PUT http://localhost:8090/api/settings/ui.enable_dark_mode \
  -d '{"value": "true"}'
```

---

### 9. Email Configuration

**Category**: `email`

| Key | Default | Description |
|-----|---------|-------------|
| `email.from_address` | `noreply@candidacy.local` | Sender email |
| `email.from_name` | `Candidacy` | Sender name |
| `email.reply_to_address` | `support@candidacy.local` | Reply-to email |
| `email.signature` | `Best regards,\nThe Candidacy Team` | Email signature |

**SMTP Configuration** (via `.env` in notification-service):

```bash
MAIL_MAILER=smtp
MAIL_HOST=mailpit              # Use mailpit for development
MAIL_PORT=1025
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
```

**Production SMTP**:

```bash
MAIL_MAILER=smtp
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-app-password
MAIL_ENCRYPTION=tls
```

---

### 10. Service URLs (Internal)

**Category**: `services`

| Key | Default | Description |
|-----|---------|-------------|
| `services.ai_service_url` | `http://ai-service:8080` | AI service endpoint |
| `services.document_parser_url` | `http://document-parser-service:8080` | Parser endpoint |
| `services.notification_service_url` | `http://notification-service:8080` | Notification endpoint |

---

## Configuration Best Practices

### 1. Security

- **Never commit `.env` to version control** (already in `.gitignore`)
- **Rotate secrets regularly** (APP_KEY, JWT_SECRET, API keys)
- **Use environment-specific values** (different keys for dev/staging/prod)
- **Mark sensitive settings** with `is_sensitive: true` in database

### 2. Performance

- **Adjust AI timeouts** based on model speed and complexity
- **Tune document parser resolution** (higher = slower but more accurate)
- **Set appropriate cache TTLs** for frequently accessed settings
- **Use auto-matching wisely** (disable for high-volume scenarios)

### 3. Monitoring

- **Track setting changes** via `change_logs` table in admin service
- **Monitor AI generation times** in Grafana dashboards
- **Watch queue lengths** for document parsing and matching
- **Review health endpoints** regularly

### 4. Deployment

```bash
# Production checklist
APP_ENV=production
APP_DEBUG=false
LOG_LEVEL=warning

# Disable development features
features.enable_ai=true          # Keep AI enabled
ui.enable_dark_mode=false        # User preference

# Secure secrets
JWT_SECRET=<strong-secret>
ai.openrouter.api_key=<production-key>
```

---

## Troubleshooting

### Settings Not Applying

```bash
# 1. Verify setting exists
curl http://localhost:8090/api/settings/ai.provider

# 2. Check service scope
# Setting must be scoped to the service using it

# 3. Restart services if requires_restart=true
docker compose restart ai-service

# 4. Clear cache
docker compose exec admin-service php artisan cache:clear
```

### AI Not Working

```bash
# 1. Check provider configuration
curl http://localhost:8090/api/settings?category=ai | jq

# 2. Verify Ollama is accessible
curl http://192.168.88.120:11535/api/tags

# 3. Check AI service logs
make logs-ai

# 4. Test AI endpoint
curl -X POST http://localhost:8084/api/ai/generate \
  -H "Content-Type: application/json" \
  -d '{"prompt": "Test", "model": "mistral"}'
```

### Document Parsing Failures

```bash
# 1. Check parser configuration
curl http://localhost:8090/api/settings?category=document_parser | jq

# 2. Increase timeout
curl -X PUT http://localhost:8090/api/settings/document_parser.timeout \
  -d '{"value": "120"}'

# 3. Check parser logs
make logs-document-parser

# 4. Verify Imagick/Poppler installed
docker compose exec document-parser-service php -m | grep imagick
```

---

## Configuration Schema

### Setting Model

```php
{
  "key": "ai.provider",
  "value": "ollama",
  "type": "string",              // string, integer, boolean
  "category": "ai",              // system, ai, recruitment, etc.
  "description": "AI provider",
  "is_public": false,            // Public settings visible to frontend
  "is_sensitive": false,         // Sensitive values masked in API
  "service_scope": "ai-service", // Which services use this setting
  "requires_restart": false,     // Requires service restart
  "validation_rules": ["in:ollama,openrouter"]
}
```

### Categories

1. **system** - Core application settings
2. **ai** - AI provider and generation settings
3. **document_parser** - Document parsing configuration
4. **recruitment** - Recruitment workflow settings
5. **storage** - File storage limits
6. **features** - Feature flags
7. **ui** - UI customization
8. **email** - Email configuration
9. **services** - Internal service URLs

---

## API Reference

### Get All Settings

```http
GET /api/settings
Authorization: Bearer {token}
```

### Get Settings by Category

```http
GET /api/settings?category=ai
Authorization: Bearer {token}
```

### Get Single Setting

```http
GET /api/settings/{key}
Authorization: Bearer {token}
```

### Update Setting

```http
PUT /api/settings/{key}
Authorization: Bearer {token}
Content-Type: application/json

{
  "value": "new-value"
}
```

### Bulk Update

```http
POST /api/settings/bulk
Authorization: Bearer {token}
Content-Type: application/json

{
  "settings": [
    {"key": "ai.provider", "value": "openrouter"},
    {"key": "ai.openrouter.model", "value": "anthropic/claude-3-haiku"}
  ]
}
```

---

## Related Documentation

- **[README.md](README.md)** - Platform overview and quick start
- **[QUICKSTART.md](QUICKSTART.md)** - Fast track setup guide
- **[ARCHITECTURE.md](ARCHITECTURE.md)** - System architecture details
- **[DATABASE.md](DATABASE.md)** - DBML schema documentation
- **[Document Parser Config](services/document-parser-service/DOCLING_CONFIG.md)** - Docling configuration

---

## Summary

| Configuration Type | Location | Purpose | Update Method |
|-------------------|----------|---------|---------------|
| **Environment Variables** | `.env` | Infrastructure, secrets | Edit file, restart services |
| **Application Settings** | Database (Admin Service) | Features, behavior | API or Admin UI (no restart) |
| **Service-Specific** | Service `.env` files | Service overrides | Docker Compose environment |

**Total Configuration Settings**: 50+ settings across 9 categories

**Access Points**:
- Admin UI: http://localhost:3501/admin/settings
- API: http://localhost:8090/api/settings
- Grafana: http://localhost:3050 (monitoring)
