# Common environment variables for all Laravel services
# Set CANDIDACY_ENV to "production" for production deployments
# Set APP_DEBUG to "false" for production
x-common-env: &common-env
  APP_ENV: ${CANDIDACY_ENV:-development}
  APP_DEBUG: ${APP_DEBUG:-true}
  LOG_LEVEL: ${LOG_LEVEL:-debug}
  LOG_CHANNEL: ${LOG_CHANNEL:-stderr}

x-laravel-env: &laravel-env
  <<: *common-env
  APP_KEY: ${APP_KEY}
  JWT_SECRET: ${JWT_SECRET}
  DB_CONNECTION: mysql
  DB_PORT: 3306
  DB_USERNAME: root
  DB_PASSWORD: root
  DB_LOG_QUERIES: ${DB_LOG_QUERIES:-true}
  REDIS_PORT: 6379

services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: candidacy-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: candidacy

    volumes:
      - mysql_data:/var/lib/mysql
      - ./infrastructure/mysql/init:/docker-entrypoint-initdb.d
    networks:
      - candidacy-network

  # Redis for caching and events
  redis:
    image: redis:7-alpine
    container_name: candidacy-redis

    networks:
      - candidacy-network

  # Ollama (optional - for local AI)
  ollama:
    image: ollama/ollama:latest
    container_name: candidacy-ollama

    volumes:
      - ollama_data:/root/.ollama
    networks:
      - candidacy-network
    # Uncomment to pull a model on startup
    # command: ["ollama", "pull", "mistral"]

    # API Gateway
  api-gateway:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: gateway/api-gateway
    container_name: candidacy-gateway
    user: "1000:1000"
    ports:
      - "9080:8080"
    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_gateway
      REDIS_HOST: redis
      APP_DEBUG: ${APP_DEBUG:-true}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
    volumes:
      - ./gateway/api-gateway:/var/www/html
      - ./gateway/api-gateway/docker/php/conf.d/uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
    depends_on:
      - redis
    networks:
      - candidacy-network

  # Auth Service
  auth-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/auth-service
    container_name: candidacy-auth
    user: "1000:1000"

    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_auth
      REDIS_HOST: redis
    volumes:
      - ./services/auth-service:/var/www/html
      - ./shared:/var/www/shared
    depends_on:
      - mysql
      - redis
    networks:
      - candidacy-network

  # Candidate Service
  candidate-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/candidate-service
    container_name: candidacy-candidate
    user: "1000:1000"

    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_candidate
      REDIS_HOST: redis
      AI_SERVICE_URL: http://ai-service:8080
      QUEUE_CONNECTION: database
      REDIS_QUEUE: candidate_queue
    volumes:
      - ./services/candidate-service:/var/www/html
      - ./shared:/var/www/shared
      - candidate_uploads:/var/www/html/storage/uploads
      - ./services/candidate-service/docker/php/conf.d/uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
    depends_on:
      - mysql
      - redis
    networks:
      - candidacy-network

  # Candidate Queue Worker
  candidate-queue-worker:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/candidate-service
    container_name: candidacy-candidate-worker
    user: "1000:1000"
    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_candidate
      REDIS_HOST: redis
      AI_SERVICE_URL: http://ai-service:8080

      QUEUE_CONNECTION: database
      REDIS_QUEUE: candidate_queue
    volumes:
      - ./services/candidate-service:/var/www/html
      - ./shared:/var/www/shared
      - candidate_uploads:/var/www/html/storage/uploads
    depends_on:
      - mysql
      - redis
      - candidate-service
    networks:
      - candidacy-network
    command: php artisan queue:work database --queue=candidate_queue --tries=3 --timeout=300
    restart: unless-stopped

  # Document Parser Service
  document-parser-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/document-parser-service
    container_name: candidacy-document-parser
    user: "1000:1000"

    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_document_parser
      REDIS_HOST: redis
      QUEUE_CONNECTION: redis
      REDIS_QUEUE: document_parser_queue
    volumes:
      - ./services/document-parser-service:/var/www/html
      - ./shared:/var/www/shared
      - document_parser_temp:/var/www/html/storage/temp
    depends_on:
      - mysql
      - redis
    networks:
      - candidacy-network

  # Document Parser Worker
  document-parser-worker:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/document-parser-service
    container_name: candidacy-document-parser-worker
    user: "1000:1000"
    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_document_parser
      REDIS_HOST: redis
      QUEUE_CONNECTION: redis
      REDIS_QUEUE: document_parser_queue
      FONTCONFIG_PATH: /var/www/html/storage
      XDG_CACHE_HOME: /var/www/html/storage/cache
    volumes:
      - ./services/document-parser-service:/var/www/html
      - ./shared:/var/www/shared
      - document_parser_temp:/var/www/html/storage/temp
    depends_on:
      - mysql
      - redis
      - document-parser-service
    networks:
      - candidacy-network
    command: php artisan queue:work --tries=3 --timeout=300
    restart: unless-stopped

  # Vacancy Service
  vacancy-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/vacancy-service
    container_name: candidacy-vacancy
    user: "1000:1000"

    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_vacancy
      REDIS_HOST: redis
      AI_SERVICE_URL: http://ai-service:8080
    volumes:
      - ./services/vacancy-service:/var/www/html
      - ./shared:/var/www/shared
    depends_on:
      - mysql
      - redis
    networks:
      - candidacy-network

  # AI Service
  ai-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/ai-service
    container_name: candidacy-ai
    user: "1000:1000"
    environment:
      <<: *laravel-env
      LOG_CHANNEL: stderr
      DB_HOST: mysql
      DB_DATABASE: candidacy_ai
      # OLLAMA_URL: http://ollama:11434
      OLLAMA_URL: http://candidacy-ollama:11434
      OLLAMA_MODEL: granite3.3:2b
      REDIS_HOST: redis
    volumes:
      - ./services/ai-service:/var/www/html
      - ./shared:/var/www/shared
    depends_on:
      #      - ollama
      - redis
    networks:
      - candidacy-network

  # Matching Service
  matching-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/matching-service
    container_name: candidacy-matching
    user: "1000:1000"

    environment:
      <<: *laravel-env
      LOG_CHANNEL: stderr
      DB_HOST: mysql
      DB_DATABASE: candidacy_matching
      REDIS_HOST: redis
      AI_SERVICE_URL: http://ai-service:8080
      CANDIDATE_SERVICE_URL: http://candidate-service:8080
      VACANCY_SERVICE_URL: http://vacancy-service:8080
      QUEUE_CONNECTION: redis
      REDIS_QUEUE: matching_queue
    volumes:
      - ./services/matching-service:/var/www/html
      - ./shared:/var/www/shared
    depends_on:
      - mysql
      - redis
    networks:
      - candidacy-network

  # Matching Queue Worker
  matching-queue-worker:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/matching-service
    container_name: candidacy-matching-worker
    user: "1000:1000"
    environment:
      <<: *laravel-env
      LOG_CHANNEL: stderr
      DB_HOST: mysql
      DB_DATABASE: candidacy_matching
      REDIS_HOST: redis
      AI_SERVICE_URL: http://ai-service:8080
      CANDIDATE_SERVICE_URL: http://candidate-service:8080
      VACANCY_SERVICE_URL: http://vacancy-service:8080
      QUEUE_CONNECTION: redis
      REDIS_QUEUE: matching_queue
    volumes:
      - ./services/matching-service:/var/www/html
      - ./shared:/var/www/shared
    depends_on:
      - mysql
      - redis
      - matching-service
    networks:
      - candidacy-network
    command: php artisan queue:work --queue=matching_queue --tries=3 --timeout=300
    restart: unless-stopped

  # Interview Service
  interview-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/interview-service
    container_name: candidacy-interview
    user: "1000:1000"

    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_interview
      REDIS_HOST: redis
    volumes:
      - ./services/interview-service:/var/www/html
      - ./shared:/var/www/shared
    depends_on:
      - mysql
      - redis
    networks:
      - candidacy-network

  # Offer Service
  offer-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/offer-service
    container_name: candidacy-offer
    user: "1000:1000"

    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_offer
      REDIS_HOST: redis
    volumes:
      - ./services/offer-service:/var/www/html
      - ./shared:/var/www/shared
    depends_on:
      - mysql
      - redis
    networks:
      - candidacy-network

  # Onboarding Service
  onboarding-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/onboarding-service
    container_name: candidacy-onboarding
    user: "1000:1000"

    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_onboarding
      REDIS_HOST: redis
    volumes:
      - ./services/onboarding-service:/var/www/html
      - ./shared:/var/www/shared
    depends_on:
      - mysql
      - redis
    networks:
      - candidacy-network

  # Reporting Service
  reporting-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/reporting-service
    container_name: candidacy-reporting
    user: "1000:1000"

    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_reporting
      REDIS_HOST: redis
    volumes:
      - ./services/reporting-service:/var/www/html
      - ./shared:/var/www/shared
    depends_on:
      - mysql
      - redis
    networks:
      - candidacy-network

  # Admin Service
  admin-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/admin-service
    container_name: candidacy-admin
    user: "1000:1000"

    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_admin
      REDIS_HOST: redis
    volumes:
      - ./services/admin-service:/var/www/html
      - ./shared:/var/www/shared
    depends_on:
      - mysql
      - redis
    networks:
      - candidacy-network

  # Notification Service
  notification-service:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/notification-service
    container_name: candidacy-notification
    user: "1000:1000"

    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_notification
      REDIS_HOST: redis
      QUEUE_CONNECTION: redis
      REDIS_QUEUE: notification_queue
      MAIL_MAILER: smtp
      MAIL_HOST: mailpit
      MAIL_PORT: 1025
      MAIL_USERNAME: null
      MAIL_PASSWORD: null
      MAIL_ENCRYPTION: null
      MAIL_FROM_ADDRESS: noreply@candidacy.local
      MAIL_FROM_NAME: Candidacy
    volumes:
      - ./services/notification-service:/var/www/html
      - ./shared:/var/www/shared
    depends_on:
      - mysql
      - redis
      - mailpit
    networks:
      - candidacy-network

  # Notification Queue Worker
  notification-queue-worker:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.service
      args:
        SERVICE_DIR: services/notification-service
    container_name: candidacy-notification-worker
    user: "1000:1000"
    environment:
      <<: *laravel-env
      DB_HOST: mysql
      DB_DATABASE: candidacy_notification
      REDIS_HOST: redis
      QUEUE_CONNECTION: redis
      REDIS_QUEUE: notification_queue
      MAIL_MAILER: smtp
      MAIL_HOST: mailpit
      MAIL_PORT: 1025
      MAIL_USERNAME: null
      MAIL_PASSWORD: null
      MAIL_ENCRYPTION: null
      MAIL_FROM_ADDRESS: noreply@candidacy.local
      MAIL_FROM_NAME: Candidacy
    volumes:
      - ./services/notification-service:/var/www/html
      - ./shared:/var/www/shared
    depends_on:
      - mysql
      - redis
      - notification-service
      - mailpit
    networks:
      - candidacy-network
    command: php artisan queue:work --queue=notification_queue --tries=3 --timeout=60
    restart: unless-stopped

  # Frontend
  frontend:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.frontend-dev
      args:
        APP_DIR: frontend/web-app
    container_name: candidacy-frontend
    ports:
      - "3501:3000"
    environment:
      - VITE_API_GATEWAY_URL=${PUBLIC_API_URL:-http://localhost:9080}
    volumes:
      - ./frontend/web-app:/app
      - /app/node_modules
    depends_on:
      - api-gateway
    networks:
      - candidacy-network

  # Applicant Frontend
  applicant-frontend:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.frontend-dev
      args:
        APP_DIR: frontend/applicant-web-app
    container_name: candidacy-applicant-frontend
    ports:
      - "5173:3000"
    environment:
      - VITE_API_BASE_URL=${PUBLIC_API_URL:-http://localhost:9080/api}
    volumes:
      - ./frontend/applicant-web-app:/app
      - /app/node_modules
    depends_on:
      - api-gateway
    networks:
      - candidacy-network

  # Centralized Logging Stack
  loki:
    image: grafana/loki:3.0.0
    container_name: candidacy-loki

    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./infrastructure/logging/loki-config.yml:/etc/loki/local-config.yaml
      - loki_data:/loki
    networks:
      - candidacy-network

  promtail:
    image: grafana/promtail:3.0.0
    container_name: candidacy-promtail
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./infrastructure/logging/promtail-config.yml:/etc/promtail/config.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    networks:
      - candidacy-network

  grafana:
    image: grafana/grafana:10.0.0
    container_name: candidacy-grafana
    ports:
      - "3050:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infrastructure/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - loki
    networks:
      - candidacy-network

  # Cloudflare Tunnel - Expose application to the internet
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: candidacy-cloudflared
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - candidacy-network
    depends_on:
      - frontend
      - applicant-frontend
      - api-gateway
      - grafana
    restart: unless-stopped

  # Mailpit - Development Email Testing
  mailpit:
    image: axllent/mailpit:latest
    container_name: candidacy-mailpit
    ports:

      - "8025:8025" # Web UI
    networks:
      - candidacy-network

  # Testing Container - For generating test documents
  testing:
    build:
      context: ./tests
      dockerfile: Dockerfile
    container_name: candidacy-testing
    profiles:
      - testing
    volumes:
      - ./tests:/tests
    networks:
      - candidacy-network

  # DBML Tools - For database schema management without requiring Node.js on host
  dbml-tools:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.dbml
    container_name: candidacy-dbml-tools
    profiles:
      - dbml
    environment:
      DB_USERNAME: root
      DB_PASSWORD: root
    volumes:
      - .:/workspace
      - /workspace/node_modules
    networks:
      - candidacy-network
    depends_on:
      - mysql

volumes:
  mysql_data:
  ollama_data:
  candidate_uploads:
  loki_data:
  grafana_data:
  document_parser_temp:


networks:
  candidacy-network:
    driver: bridge
